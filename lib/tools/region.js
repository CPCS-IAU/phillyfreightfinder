$(function(){function a(){function a(){var a=$("#c-map-wrapper").width(),b=420;0===$("#c-region-map").length&&d3.json("data/county5k.js",function(c){C=c;var d=d3.select("#c-county-map").append("svg").attr("width",a).attr("height",b).attr("id","c-region-map"),e=d.append("g").attr("width",a).attr("height",b).attr("id","counties"),f=d.append("g").attr("width",a).attr("height",b).attr("id","cty_labels"),g=d3.geo.mercator().scale(1).translate([0,0]).precision(0),h=d3.geo.path().projection(g),i=h.bounds(c),j=1/Math.max((i[1][0]-i[0][0])/a,(i[1][1]-i[0][1])/b),k=[(a-j*(i[1][0]+i[0][0]))/2,(b-j*(i[1][1]+i[0][1]))/2];g.scale(j).translate(k),e.selectAll("path").data(c.features).enter().append("path").attr("d",h).attr("id",function(a){return"c-"+a.properties.NAME.toLowerCase()}).attr("class","county_outlines").on("mouseover",function(){var a=d3.select(this);a.transition().duration(250).style("fill-opacity","0.8"),a.style("stroke-width","5px"),a.moveToFront()}).on("mouseleave",function(){var a=d3.select(this);a.transition().delay(5).style("stroke-width","2px").style("fill-opacity","1")}).on("click",function(){$("#c-county-prompt").hide();var a=d3.select(this).attr("id").split("-");J=a[1],I=P[J],window.location.hash="region/"+J+"/"+K});f.selectAll("text").data(c.features).enter().append("text").attr("class","c-county-label").attr("transform",function(a){return"translate("+h.centroid(a)+")"}).text(function(a){return a.properties.NAME})})}function b(a){switch(a){case"region":$(".c-nav").hide();break;case"network":$(".c-nav-left").hide(),$(".c-nav-right").show(),$("#c-nav-right-label").html("Freight Centers");break;case"freight_centers":$(".c-nav-left").show(),$(".c-nav-right").show(),$("#c-nav-left-label").html("Network"),$("#c-nav-right-label").html("Domestic Trade");break;case"domestic_trade":$(".c-nav-left").show(),$(".c-nav-right").hide(),$("#c-nav-left-label").html("Freight Centers")}}function c(c){J=c.length>1?c[1]:"none",K=c.length>1?c[2]:"region",I=P[J];var d=$('#c-steps li a[data-target="c-'+K+'"] ');$(".c-step-current").find("svg.c-step-nav circle:first").attr("r",5),$(".c-step-current").find("svg.c-step-nav circle:nth-child(2)").attr("r",6),$(".c-step-current").toggleClass("c-step-current"),d.closest("li").toggleClass("c-step-current"),d.find("svg.c-step-nav circle:first").attr("r",8),d.find("svg.c-step-nav circle:nth-child(2)").attr("r",3),$(".c-region-tab").hide(),$("#c-"+K).show(),$("#c-name").html(h(J)+" County"),$("#c-tab").html(N[K]),b(K),"region"===K?(D=$("#c-explore-emphasis").width(),$("#c-explore-emphasis").css("width",D+"px"),L=$("#content").width(),a(),K="network",J="none",$("#c-name").html("DVRPC Region")):"domestic_trade"===K&&($(".loading_panel").show(),j())}function d(a,b,c){var d=0,e=window.setInterval(function(){a(),++d===c&&window.clearInterval(e)},b)}function e(){$("#c-county-prompt").hasClass("c-light")?$("#c-county-prompt").css("background-color","#312867").toggleClass("c-light"):$("#c-county-prompt").css("background-color","#7a6aa2").toggleClass("c-light")}function f(){d(e,250,10)}function g(a){function b(){c.style("stroke-width","0px"),c.transition().duration(1).attr("r",8),c.style("stroke-opacity",1)}var c=d3.select("#"+a).select("circle");setTimeout(b,351),c.style("stroke-width","1px"),c.transition().duration(348).attr("r",20),c.style("stroke-opacity",0)}function h(a){return a.charAt(0).toUpperCase()+a.slice(1)}function j(){d3.csv("data/d3/commRegions_v2.csv",function(a){d3.csv("data/d3/totalFlowsBEA.csv",function(b){d3.csv("data/d3/commodities.csv",function(c){d3.csv("data/d3/stcc.csv",function(d){d3.json("data/d3/us_states_shapes.json",function(e){T=a,U=b,V=c,W=d,X=e,"domestic_trade"===K&&k()})})})})})}function k(){if(L=$("#content").width(),0===$("#tradeMap").length){F="in",G="ton",H="all";var a=d3.select("#content").append("svg").attr("width",L).attr("height",430).attr("id","tradeMap"),b=a.append("g").attr("width",L).attr("height",430).attr("id","states");a.append("g").attr("width",L).attr("height",430).attr("id","metros"),a.append("g").attr("width",L).attr("height",430).attr("id","temp");var c=d3.geo.path().projection(M),d=c.bounds(X),e=(d[1][0]-d[0][0]-15)/(L-50),f=(d[1][1]-d[0][1])/430,g=e>f?900/e:900,h=e>f?e:1;A=h>1?1/h:1,B=1/h*(d[1][0]-d[0][0])/2;var i=[B,215];M.scale(g).translate(i),b.selectAll("path").data(X.features).enter().append("path").attr("d",c).attr("class","states_outline");for(var j=[],k=[],l=0;l<U.length;l++)j.push(parseInt(U[l].region_id)),k.push(parseInt(U[l].rel_region_id));j=p(j),k=p(k),Y=p(j.concat(k)),r(Y,3),v(I,F),$(".loading_panel").fadeOut("slow"),Z=!1}else $("#metros").empty(),F="in",G="ton",H="all",r(Y,3),v(I,F),$("#radio_"+G).trigger("click"),$("#radio_"+F).trigger("click"),$("#"+H).trigger("click"),$("#comm-in").prop("checked",!0),$("#tradeDirection").html("Inbound <span class='caret'></span>"),$("#comm-ton").prop("checked",!0),$("#tradeMeasure").html("Volume <span class='caret'></span>"),$("#comm-"+G).prop("checked",!0),$(".loading_panel").fadeOut("slow")}function l(a,b,c,d){var e,f=a,g=b,h=c,i=d,j=[];for(e=0;e<V.length;e++){var k=V[e];k.dir===h&&parseInt(k.region)===f&&k.mode.toLowerCase()===i&&j.push(k)}var l=m(j,g);n(l)}function m(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.value-a.value}),a}function n(a){function b(a){var b=j(a);"ton"===G?g.push(parseInt(a.ton)):g.push(parseInt(a.value)),f.push(b)}function c(){return d3.svg.axis().scale(q).orient("bottom").ticks(5)}function d(){return"ton"===G?"thousand tons of activity":"million dollars of activity"}function e(a){var b;return b="ton"===G?numeral(u(.001*a,2)).format("0,0"):"$ "+numeral(u(1e-6*a,2)).format("0,0")}var f=[],g=[];$("#commChart").empty().html("");var h,i=["#312A6A","#323576","#35478A","#36559A","#2E5EA5","#396ab2","#4276c2","#5584c9","#6992cf","#7ca0d5"],j=function(a){var b,c=null;for(b=0;b<W.length;b++){var d=W[b];parseInt(d.stcc)===parseInt(a.stcc4)&&(c=d.name)}return c};if(a.length<10)for(h=0;h<a.length;h++)y=a[h],b(y);else for(h=0;10>h;h++)y=a[h],b(y);var k=$("#topCommoditiesChart").width(),l=305,m=275,n=(l-30)/g.length,o=d3.select("#commChart").attr("width",k).attr("height",l),p=d3.scale.quantize().domain([0,f.length]).range(i),q=d3.scale.linear().range([0,k-250]).domain([0,d3.max(g)]),r=d3.scale.linear().domain([0,f.length]).range([0,m]),s=d3.svg.axis().orient("left").scale(r).ticks(f.length).tickSize(0).tickFormat(function(a,b){return f[b]});o.append("g").attr("class","x axis").attr("transform","translate(220,"+m+")").call(c().tickSize(2).tickFormat(e)),o.append("g").attr("class","grid").attr("transform","translate(220,"+m+")").style("stroke-dasharray","1, 2").call(c().tickSize(-m,0,0).tickFormat(""));o.append("g").attr("transform","translate(220,0)").attr("id","yaxis").call(s).selectAll("text").attr("y",n/2);o.append("text").attr("class","x-label").attr("text-anchor","end").attr("x",k/2+110).attr("y",l-2).text(d);var t=o.append("g").attr("transform","translate(220, 0)").attr("id","bars").selectAll("rect").data(g).enter();t.append("rect").attr("transform",function(a,b){return"translate(0, "+b*n+")"}).attr("width",0).attr("height",n-2).attr("class","barTip").style("fill",function(a,b){return p(b)}).transition().delay(function(a,b){return 100*b}).duration(400).attr("width",q).attr("val",function(a,b){return a}),$(".barTip").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val");return z="ton"===G?numeral(u(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(u(1e-6*a,2)).format("0,0.0")+" M"}})}function o(a,b){return a-b}function p(a){a=a.sort(o);var b,c=[];for(b=0;b<a.length;b++)a[b]!==a[b-1]&&c.push(a[b]);return c}function q(a){var b,c=null;for(b=0;b<T.length;b++){var d=T[b];parseInt(d.id)===parseInt(a)&&(c=d)}return c}function r(a,b){var c;d3.geo.albersUsa();for(c=0;c<a.length;c++){var d=q(a[c]);if(d){var e=M([d.lon,d.lat]),f=d3.select("#metros").append("g").attr("transform","translate("+Math.round(e[0])+","+Math.round(e[1])+")").attr("r",b).attr("id","metro_"+d.id).attr("class","metro related");f.append("circle").attr("r",b);d.id}}}function s(){$(".flowBtn").attr("disabled",!1),"bucks"===J?$("#dt-county-prev").prop("disabled",!0):"philadelphia"===J?$("#dt-county-next").prop("disabled",!0):($("#dt-county-next").prop("disabled",!1),$("#dt-county-prev").prop("disabled",!1))}function t(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.val-a.val}),a}function u(a,b){return Number(Math.round(a+"e"+b)+"e-"+b)}function v(a,b,c){$(".flowBtn").attr("disabled",!0),$("#tradeList").html(""),setTimeout(s,520);var d,e=t(U,G),f=[],g=[],h=[],j=[],k=0;for(d=0;d<e.length;d++){var m=e[d];parseInt(m.region_id)===a&&m.rel_region_id!=m.region_id&&m.dir===b&&m.mode===H&&("ton"===G?f.push(parseInt(m.ton)):f.push(parseInt(m.val)))}g=d3.min(f),h=d3.max(f);var n=d3.scale.pow().exponent(.6).domain([g,h]).range([2,35*A]);d3.select("#metros .sel_primary").classed("prevSelection",!0),d3.selectAll("#metros .sel_related").classed("prevSelection",!0),d3.selectAll("#metros .metro").classed("sel_primary",!1).classed("sel_related",!1).classed("in",!1).classed("out",!1),$("svg circle").unbind("mouseenter mouseleave"),d3.select("#metro_"+a).attr("r",15).classed("sel_primary",!0).classed("prevSelection",!1).select("circle").attr("r",15);var o;for(o=0;o<e.length;o++){var p,r,v,x,y=e[o];if("ton"===G?(p=n(y.ton),v=y.ton,x=numeral(u(.001*v,2)).format("0,0.0")+" ktons"):(p=n(y.val),v=y.val,x="$ "+numeral(u(1e-6*v,2)).format("0,0.0")+" M"),parseInt(y.region_id)===a&&y.dir===b&&y.rel_region_id!=y.region_id&&y.mode===H){var z=d3.select("#metro_"+y.rel_region_id),B=q(y.rel_region_id),C=B.id,D=B.familiar_name;if(v>0){var E="<li class='list-group-item' data-id='"+C+"'><span class='badge partner-val'>"+x+"</span>"+D+"</li>";j.push(E)}z.classed("prevSelection",!1),z.classed("sel_related",!0).attr("r",p).classed(b,!0).select("circle").transition().duration(500).attr("r",p).attr("i",k).attr("val",v).attr("name",D),k++}}var F;if(j.length>0)for(i=0;i<10;i++)F=j[i],$(F).appendTo("#tradeList");else{var K=J.slice(0,1).toUpperCase()+J.slice(1,J.length);F="<li class='list-group-item'><b>"+K+" County</b> has no domestic trade using <b>"+H+" transportation.</b></li>","air"===H&&42101===a&&(F+="<li class='list-group-item'>Air transportation through Philadelphia International Airport is captured by Delaware County.</li>"),$(F).appendTo("#tradeList")}d3.selectAll("#metros .prevSelection").classed("prevSelection",!1).attr("r",3).select("circle").transition().duration(500).attr("r",3),w(),$("svg .sel_related circle").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val"),b=this.getAttribute("name");u(a,2);return r="ton"===G?numeral(u(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(u(1e-6*a,2)).format("0,0.0")+" M","<b>"+b+"</b><br>"+r}}),d3.selectAll(".metro circle").on("mouseover",null),d3.selectAll(".metro circle").on("mouseout",null),d3.selectAll(".sel_related circle").on("mouseover",function(a){d3.select(this).classed("active",!0)}).on("mouseout",function(a){d3.select(this).classed("active",!1)}),l(I,G,b,H)}function w(){var a=d3.selectAll("#metros .metro")[0];E.elements(a).start()}function x(){0===$("#tradeMap").length&&k(),l(I,G,F,H)}var y,z,A,B,C,D,E=sm.packer(),F="in",G="ton",H="all",I=42017,J="none",K="network",L=$("#content").width(),M=d3.geo.albersUsa().scale(900).translate([L,215]),N={region:"Overview",network:"Network",freight_centers:"Freight Centers",domestic_trade:"Domestic Trade Patterns"},O={Network:"network","Freight Centers":"freight_centers","Domestic Trade":"domestic_trade"},P={bucks:42017,burlington:34005,camden:34007,gloucester:34015,mercer:34021,chester:42029,delaware:42045,montgomery:42091,philadelphia:42101},Q=($("#c-region-title").width()-450)/5;line_width=Q/2*3+18,$(".c-step-item").css("width",Q+"px"),$(".c-step-line").css("width",2*Q+"px").css("transform","translate("+line_width+"px, 0)");var R=document.location.toString();if(R.match("#")){var S=R.split("#")[1].split("/");S.length>1?c(S):($("#c-region").fadeIn(),$("#c-name").html("DVRPC Region"),$("#c-tab").html("Overview"),D=$("#c-explore-emphasis").width(),$("#c-explore-emphasis").css("width",D+"px"),a(),$("#c-explorer-block").fadeOut("slow"))}$('a[href="#"]').click(function(a){a.preventDefault()}),$(window).bind("hashchange",function(){if("region"===getLocationHash()){var a=window.location.hash.substring(1),b=a.split("/");c(b)}}),$(document.body).on("click","#c-steps li a ",function(){K=$(this).attr("data-target").split("-")[1],"none"===J?($("#c-county-prompt").show(),f()):"region"===K?window.location.hash="region":window.location.hash="region/"+J+"/"+K}),$(document.body).on("click",".c-nav",function(){var a=$(this).find("span").text();K=O[a],window.location.hash="region/"+J+"/"+K}),$(document.body).on("mouseover","#c-explore-emphasis",function(){$("#c-explore-emphasis").css("width",D+100+"px")}),$(document.body).on("mouseout","#c-explore-emphasis",function(){$("#c-explore-emphasis").css("width",D+"px")}),$("#c-county-prompt").on("click",function(){$("#c-county-prompt").hide()}),$("#c-steps li a svg").bind("mouseenter",function(){g($(this).parent().find("svg.c-ripple").attr("id"))}),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var T,U,V,W,X,Y,Z=!1;$("input[name='dir']").change(function(){F=$(this).val();var a="in"===F?"Inbound":"Outbound";v(I,F),$("#comm-"+F).prop("checked",!0),$("#tradeDirection").html(a+" <span class='caret'></span>")}),$("input[name='measure']").change(function(){G=$(this).val();var a="ton"===G?"Volume":"Value";v(I,F,"measure"),$("#comm-"+G).prop("checked",!0),$("#tradeMeasure").html(a+" <span class='caret'></span>")}),$("input[name='mode']").change(function(){H=$(this).val(),v(I,F,"measure")}),$("input[name='tradeMeasure']").change(function(){G=$(this).val(),$("#radio_"+G).trigger("click")}),$("input[name='tradeDirection']").change(function(){F=$(this).val(),$("#radio_"+F).trigger("click")}),$(".btn").mouseup(function(){$(this).blur()}),$(document.body).on("mouseover","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!0)}),$(document.body).on("mouseout","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!1)}),$(window).bind("resize",function(){x()})}executeOnLoad("c-region-nav",a)});