$(function(){var a,b,c,d,e=sm.packer(),f="in",g="ton",h="all",j=42017,k="none",l="c-network",m=$("#content").width(),n=d3.geo.albersUsa().scale(900).translate([m,215]),o={region:"Overview",network:"Network",freight:"Freight Centers",domestic:"Domestic Trade Patterns"},p={bucks:42017,burlington:34005,camden:34007,gloucester:34015,mercer:34021,chester:42029,delaware:42045,montgomery:42091,philadelphia:42101};d3.csv("data/d3/commRegions_v2.csv",function(q){d3.csv("data/d3/totalFlowsBEA.csv",function(r){d3.csv("data/d3/commodities.csv",function(s){d3.csv("data/d3/stcc.csv",function(t){d3.json("data/d3/us_states_shapes.json",function(u){function v(a,b){var c=a.split("-");cname=c[1],$(".c-step-current").find("svg.c-step-nav circle:first").attr("r",5),$(".c-step-current").find("svg.c-step-nav circle:nth-child(2)").attr("r",6),$(".c-step-current").toggleClass("c-step-current"),b.closest("li").toggleClass("c-step-current"),b.find("svg.c-step-nav circle:first").attr("r",8),b.find("svg.c-step-nav circle:nth-child(2)").attr("r",3),$(".c-region-tab").hide(),$("#"+a).show(),$("#c-tab").html(o[cname]),m=$("#content").width(),"c-domestic-trade"===a?(P(),D(j,g,f,h)):"c-region"===a&&(l="c-network",k="none",$("#c-name").html("DVRPC Region"))}function w(a,b,c){var d=0,e=window.setInterval(function(){a(),++d===c&&window.clearInterval(e)},b)}function x(){$("#c-county-prompt").hasClass("c-light")?$("#c-county-prompt").css("background-color","#312867").toggleClass("c-light"):$("#c-county-prompt").css("background-color","#7a6aa2").toggleClass("c-light")}function y(){w(x,250,10)}function z(a){function b(){a.find("circle").attr("r",8).attr("stroke-width",0).attr("stroke-opacity",1)}setTimeout(b,351),a.find("circle").attr("r",20).attr("stroke-width",1).attr("stroke-opacity",0)}function A(a){return a.charAt(0).toUpperCase()+a.slice(1)}function B(){var a=$("#c-map-wrapper").width(),b=420;0===$("#c-region-map").length&&d3.json("data/county5k.js",function(c){var d=d3.select("#c-county-map").append("svg").attr("width",a).attr("height",b).attr("id","c-region-map"),e=d.append("g").attr("width",a).attr("height",b).attr("id","counties"),f=d.append("g").attr("width",a).attr("height",b).attr("id","cty_labels"),g=d3.geo.mercator().scale(1).translate([0,0]).precision(0),h=d3.geo.path().projection(g),i=h.bounds(c),m=1/Math.max((i[1][0]-i[0][0])/a,(i[1][1]-i[0][1])/b),n=[(a-m*(i[1][0]+i[0][0]))/2,(b-m*(i[1][1]+i[0][1]))/2];g.scale(m).translate(n),e.selectAll("path").data(c.features).enter().append("path").attr("d",h).attr("id",function(a){return"c-"+a.properties.NAME.toLowerCase()}).attr("class","county_outlines").on("mouseover",function(){var a=d3.select(this);a.moveToFront()}).on("click",function(){$("#c-county-prompt").hide();var a=d3.select(this).attr("id").split("-");k=a[1],j=p[k],$("#c-name").html(A(k)+" County"),$("#c-steps li a[data-target="+l+"] ").trigger("click")});f.selectAll("text").data(c.features).enter().append("text").attr("class","c-county-label").attr("transform",function(a){return"translate("+h.centroid(a)+")"}).text(function(a){return a.properties.NAME})})}function C(){if(0===$("#tradeMap").length){var a=d3.select("#content").append("svg").attr("width",m).attr("height",430).attr("id","tradeMap"),b=a.append("g").attr("width",m).attr("height",430).attr("id","states");a.append("g").attr("width",m).attr("height",430).attr("id","metros"),a.append("g").attr("width",m).attr("height",430).attr("id","temp");var e=d3.geo.path().projection(n),g=e.bounds(u),h=(g[1][0]-g[0][0]-15)/(m-50),i=(g[1][1]-g[0][1])/430,k=h>i?900/h:900,l=h>i?h:1;c=l>1?1/l:1,d=1/l*(g[1][0]-g[0][0])/2;var o=[d,215];n.scale(k).translate(o),b.selectAll("path").data(u.features).enter().append("path").attr("d",e).attr("class","states_outline");for(var p=[],q=[],s=0;s<r.length;s++)p.push(parseInt(r[s].region_id)),q.push(parseInt(r[s].rel_region_id));p=H(p),q=H(q);var t=H(p.concat(q));J(t,3),N(j,f)}}function D(a,b,c,d){var e,f=a,g=b,h=c,i=d,j=[];for(e=0;e<s.length;e++){var k=s[e];k.dir===h&&parseInt(k.region)===f&&k.mode.toLowerCase()===i&&j.push(k)}var l=E(j,g);F(l)}function E(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.value-a.value}),a}function F(c){function d(a){var b=m(a);"ton"===g?j.push(parseInt(a.ton)):j.push(parseInt(a.value)),i.push(b)}function e(){return d3.svg.axis().scale(u).orient("bottom").ticks(5)}function f(){return"ton"===g?"thousand tons of activity":"million dollars of activity"}function h(a){var b;return b="ton"===g?numeral(M(.001*a,2)).format("0,0"):"$ "+numeral(M(1e-6*a,2)).format("0,0")}var i=[],j=[];$("#commChart").empty().html("");var k,l=["#312A6A","#323576","#35478A","#36559A","#2E5EA5","#396ab2","#4276c2","#5584c9","#6992cf","#7ca0d5"],m=function(a){var b,c=null;for(b=0;b<t.length;b++){var d=t[b];parseInt(d.stcc)===parseInt(a.stcc4)&&(c=d.name)}return c};if(c.length<10)for(k=0;k<c.length;k++)a=c[k],d(a);else for(k=0;10>k;k++)a=c[k],d(a);var n=$("#topCommoditiesChart").width(),o=305,p=275,q=(o-30)/j.length,r=d3.select("#commChart").attr("width",n).attr("height",o),s=d3.scale.quantize().domain([0,i.length]).range(l),u=d3.scale.linear().range([0,n-250]).domain([0,d3.max(j)]),v=d3.scale.linear().domain([0,i.length]).range([0,p]),w=d3.svg.axis().orient("left").scale(v).ticks(i.length).tickSize(0).tickFormat(function(a,b){return i[b]});r.append("g").attr("class","x axis").attr("transform","translate(220,"+p+")").call(e().tickSize(2).tickFormat(h)),r.append("g").attr("class","grid").attr("transform","translate(220,"+p+")").style("stroke-dasharray","1, 2").call(e().tickSize(-p,0,0).tickFormat(""));r.append("g").attr("transform","translate(220,0)").attr("id","yaxis").call(w).selectAll("text").attr("y",q/2);r.append("text").attr("class","x-label").attr("text-anchor","end").attr("x",n/2+110).attr("y",o-2).text(f);var x=r.append("g").attr("transform","translate(220, 0)").attr("id","bars").selectAll("rect").data(j).enter();x.append("rect").attr("transform",function(a,b){return"translate(0, "+b*q+")"}).attr("width",0).attr("height",q-2).attr("class","barTip").style("fill",function(a,b){return s(b)}).transition().delay(function(a,b){return 100*b}).duration(400).attr("width",u).attr("val",function(a,b){return a}),$(".barTip").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val");return b="ton"===g?numeral(M(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(M(1e-6*a,2)).format("0,0.0")+" M"}})}function G(a,b){return a-b}function H(a){a=a.sort(G);var b,c=[];for(b=0;b<a.length;b++)a[b]!==a[b-1]&&c.push(a[b]);return c}function I(a){var b,c=null;for(b=0;b<q.length;b++){var d=q[b];parseInt(d.id)===parseInt(a)&&(c=d)}return c}function J(a,b){var c;d3.geo.albersUsa();for(c=0;c<a.length;c++){var d=I(a[c]);if(d){var e=n([d.lon,d.lat]),f=d3.select("#metros").append("g").attr("transform","translate("+Math.round(e[0])+","+Math.round(e[1])+")").attr("r",b).attr("id","metro_"+d.id).attr("class","metro related");f.append("circle").attr("r",b);d.id}}}function K(){$(".flowBtn").attr("disabled",!1),"bucks"===k?$("#dt-county-prev").prop("disabled",!0):"philadelphia"===k?$("#dt-county-next").prop("disabled",!0):($("#dt-county-next").prop("disabled",!1),$("#dt-county-prev").prop("disabled",!1))}function L(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.val-a.val}),a}function M(a,b){return Number(Math.round(a+"e"+b)+"e-"+b)}function N(a,b,d){console.log(c),$(".flowBtn").attr("disabled",!0),$("#tradeList").html(""),setTimeout(K,520);var e,f=L(r,g),l=[],m=[],n=[],o=[],p=0;for(e=0;e<f.length;e++){var q=f[e];parseInt(q.region_id)===a&&q.rel_region_id!=q.region_id&&q.dir===b&&q.mode===h&&("ton"===g?l.push(parseInt(q.ton)):l.push(parseInt(q.val)))}m=d3.min(l),n=d3.max(l);var s=d3.scale.pow().exponent(.6).domain([m,n]).range([2,35*c]);d3.select("#metros .sel_primary").classed("prevSelection",!0),d3.selectAll("#metros .sel_related").classed("prevSelection",!0),d3.selectAll("#metros .metro").classed("sel_primary",!1).classed("sel_related",!1).classed("in",!1).classed("out",!1),$("svg circle").unbind("mouseenter mouseleave"),d3.select("#metro_"+a).attr("r",15).classed("sel_primary",!0).classed("prevSelection",!1).select("circle").attr("r",15);var t;for(t=0;t<f.length;t++){var u,v,w,x,y=f[t];if("ton"===g?(u=s(y.ton),w=y.ton,x=numeral(M(.001*w,2)).format("0,0.0")+" ktons"):(u=s(y.val),w=y.val,x="$ "+numeral(M(1e-6*w,2)).format("0,0.0")+" M"),parseInt(y.region_id)===a&&y.dir===b&&y.rel_region_id!=y.region_id&&y.mode===h){var z=d3.select("#metro_"+y.rel_region_id),A=I(y.rel_region_id),B=A.id,C=A.familiar_name;if(w>0){var E="<li class='list-group-item' data-id='"+B+"'><span class='badge partner-val'>"+x+"</span>"+C+"</li>";o.push(E)}z.classed("prevSelection",!1),z.classed("sel_related",!0).attr("r",u).classed(b,!0).select("circle").transition().duration(500).attr("r",u).attr("i",p).attr("val",w).attr("name",C),p++}}var F;if(o.length>0)for(i=0;i<10;i++)F=o[i],$(F).appendTo("#tradeList");else{var G=k.slice(0,1).toUpperCase()+k.slice(1,k.length);F="<li class='list-group-item'><b>"+G+" County</b> has no domestic trade using <b>"+h+" transportation.</b></li>","air"===h&&42101===a&&(F+="<li class='list-group-item'>Air transportation through Philadelphia International Airport is captured by Delaware County.</li>"),$(F).appendTo("#tradeList")}d3.selectAll("#metros .prevSelection").classed("prevSelection",!1).attr("r",3).select("circle").transition().duration(500).attr("r",3),O(),$("svg .sel_related circle").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val"),b=this.getAttribute("name");M(a,2);return v="ton"===g?numeral(M(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(M(1e-6*a,2)).format("0,0.0")+" M","<b>"+b+"</b><br>"+v}}),d3.selectAll(".metro circle").on("mouseover",null),d3.selectAll(".metro circle").on("mouseout",null),d3.selectAll(".sel_related circle").on("mouseover",function(a){d3.select(this).classed("active",!0)}).on("mouseout",function(a){d3.select(this).classed("active",!1)}),D(j,g,b,h)}function O(){var a=d3.selectAll("#metros .metro")[0];e.elements(a).start()}function P(){0===$("#tradeMap").length&&C(),D(j,g,f,h)}$('a[href="#"]').click(function(a){a.preventDefault()}),$(document.body).on("click","#c-steps li a ",function(){l=$(this).attr("data-target");var a=$(this);"none"===k?($("#c-county-prompt").show(),y()):v(l,a)}),$("#c-county-prompt").on("click",function(){$("#c-county-prompt").hide()}),$("#c-steps li a svg").bind("mouseover",function(){z($(this).parent().find("svg.c-ripple"))}),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},B(),$("input[name='dir']").change(function(){f=$(this).val();var a="in"===f?"Inbound":"Outbound";N(j,f),$("#comm-"+f).prop("checked",!0),$("#tradeDirection").html(a+" <span class='caret'></span>")}),$("input[name='county']").change(function(){d3.selectAll("#temp text").remove(),k=this.id,j=parseInt($(this).val()),N(j,f)}),$("input[name='measure']").change(function(){g=$(this).val();var a="ton"===g?"Volume":"Value";N(j,f,"measure"),$("#comm-"+g).prop("checked",!0),$("#tradeMeasure").html(a+" <span class='caret'></span>")}),$("input[name='mode']").change(function(){h=$(this).val(),N(j,f,"mode")}),$("input[name='tradeMeasure']").change(function(){g=$(this).val(),$("#radio_"+g).trigger("click")}),$("input[name='tradeDirection']").change(function(){f=$(this).val(),$("#radio_"+f).trigger("click")}),$("#dt-county-prev").on("click",function(){var a=$("#"+k).parent().prev().children();a.trigger("click")}),$("#dt-county-next").on("click",function(){var a=$("#"+k).parent().next().children();a.trigger("click")}),$(".btn").mouseup(function(){$(this).blur()}),$(document.body).on("mouseover","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!0)}),$(document.body).on("mouseout","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!1)}),$(window).bind("resize",function(){P()})})})})})})});