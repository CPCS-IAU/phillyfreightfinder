$(function(){function a(){var a=$("#c-map-wrapper").width(),b=420;0===$("#c-region-map").length&&d3.json("data/county5k.js",function(c){B=c;var d=d3.select("#c-county-map").append("svg").attr("width",a).attr("height",b).attr("id","c-region-map"),e=d.append("g").attr("width",a).attr("height",b).attr("id","counties"),f=d.append("g").attr("width",a).attr("height",b).attr("id","cty_labels"),g=d3.geo.mercator().scale(1).translate([0,0]).precision(0),h=d3.geo.path().projection(g),i=h.bounds(c),j=1/Math.max((i[1][0]-i[0][0])/a,(i[1][1]-i[0][1])/b),k=[(a-j*(i[1][0]+i[0][0]))/2,(b-j*(i[1][1]+i[0][1]))/2];g.scale(j).translate(k),e.selectAll("path").data(c.features).enter().append("path").attr("d",h).attr("id",function(a){return"c-"+a.properties.NAME.toLowerCase()}).attr("class","county_outlines").on("mouseover",function(){var a=d3.select(this);a.moveToFront()}).on("click",function(){$("#c-county-prompt").hide();var a=d3.select(this).attr("id").split("-");H=a[1],G=M[H],window.location.hash="region/"+H+"/"+I});f.selectAll("text").data(c.features).enter().append("text").attr("class","c-county-label").attr("transform",function(a){return"translate("+h.centroid(a)+")"}).text(function(a){return a.properties.NAME})})}function b(b){H=b.length>1?b[1]:"none",I=b.length>1?b[2]:"region",G=M[H];var c=$('#c-steps li a[data-target="c-'+I+'"] ');$(".c-step-current").find("svg.c-step-nav circle:first").attr("r",5),$(".c-step-current").find("svg.c-step-nav circle:nth-child(2)").attr("r",6),$(".c-step-current").toggleClass("c-step-current"),c.closest("li").toggleClass("c-step-current"),c.find("svg.c-step-nav circle:first").attr("r",8),c.find("svg.c-step-nav circle:nth-child(2)").attr("r",3),$(".c-region-tab").hide(),$("#c-"+I).show(),$("#c-name").html(g(H)+" County"),$("#c-tab").html(L[I]),"region"===I?(J=$("#content").width(),a(),I="network",H="none",$("#c-name").html("DVRPC Region")):"domestic_trade"===I&&($("#loading_panel").show(),h())}function c(a,b,c){var d=0,e=window.setInterval(function(){a(),++d===c&&window.clearInterval(e)},b)}function d(){$("#c-county-prompt").hasClass("c-light")?$("#c-county-prompt").css("background-color","#312867").toggleClass("c-light"):$("#c-county-prompt").css("background-color","#7a6aa2").toggleClass("c-light")}function e(){c(d,250,10)}function f(a){function b(){a.find("circle").attr("r",8).attr("stroke-width",0).attr("stroke-opacity",1)}setTimeout(b,351),a.find("circle").attr("r",20).attr("stroke-width",1).attr("stroke-opacity",0)}function g(a){return a.charAt(0).toUpperCase()+a.slice(1)}function h(){d3.csv("data/d3/commRegions_v2.csv",function(a){d3.csv("data/d3/totalFlowsBEA.csv",function(b){d3.csv("data/d3/commodities.csv",function(c){d3.csv("data/d3/stcc.csv",function(d){d3.json("data/d3/us_states_shapes.json",function(e){P=a,Q=b,R=c,S=d,T=e,"domestic_trade"===I&&j()})})})})})}function j(){if(J=$("#content").width(),0===$("#tradeMap").length){D="in",E="ton",F="all";var a=d3.select("#content").append("svg").attr("width",J).attr("height",430).attr("id","tradeMap"),b=a.append("g").attr("width",J).attr("height",430).attr("id","states");a.append("g").attr("width",J).attr("height",430).attr("id","metros"),a.append("g").attr("width",J).attr("height",430).attr("id","temp");var c=d3.geo.path().projection(K),d=c.bounds(T),e=(d[1][0]-d[0][0]-15)/(J-50),f=(d[1][1]-d[0][1])/430,g=e>f?900/e:900,h=e>f?e:1;z=h>1?1/h:1,A=1/h*(d[1][0]-d[0][0])/2;var i=[A,215];K.scale(g).translate(i),b.selectAll("path").data(T.features).enter().append("path").attr("d",c).attr("class","states_outline");for(var j=[],k=[],l=0;l<Q.length;l++)j.push(parseInt(Q[l].region_id)),k.push(parseInt(Q[l].rel_region_id));j=o(j),k=o(k),U=o(j.concat(k)),q(U,3),u(G,D),$("#loading_panel").fadeOut(),V=!1}else $("#metros").empty(),D="in",E="ton",F="all",q(U,3),u(G,D),$("#radio_"+E).trigger("click"),$("#radio_"+D).trigger("click"),$("#"+F).trigger("click"),$("#comm-in").prop("checked",!0),$("#tradeDirection").html("Inbound <span class='caret'></span>"),$("#comm-ton").prop("checked",!0),$("#tradeMeasure").html("Volume <span class='caret'></span>"),$("#comm-"+E).prop("checked",!0),$("#loading_panel").fadeOut()}function k(a,b,c,d){var e,f=a,g=b,h=c,i=d,j=[];for(e=0;e<R.length;e++){var k=R[e];k.dir===h&&parseInt(k.region)===f&&k.mode.toLowerCase()===i&&j.push(k)}var n=l(j,g);m(n)}function l(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.value-a.value}),a}function m(a){function b(a){var b=j(a);"ton"===E?g.push(parseInt(a.ton)):g.push(parseInt(a.value)),f.push(b)}function c(){return d3.svg.axis().scale(q).orient("bottom").ticks(5)}function d(){return"ton"===E?"thousand tons of activity":"million dollars of activity"}function e(a){var b;return b="ton"===E?numeral(t(.001*a,2)).format("0,0"):"$ "+numeral(t(1e-6*a,2)).format("0,0")}var f=[],g=[];$("#commChart").empty().html("");var h,i=["#312A6A","#323576","#35478A","#36559A","#2E5EA5","#396ab2","#4276c2","#5584c9","#6992cf","#7ca0d5"],j=function(a){var b,c=null;for(b=0;b<S.length;b++){var d=S[b];parseInt(d.stcc)===parseInt(a.stcc4)&&(c=d.name)}return c};if(a.length<10)for(h=0;h<a.length;h++)x=a[h],b(x);else for(h=0;10>h;h++)x=a[h],b(x);var k=$("#topCommoditiesChart").width(),l=305,m=275,n=(l-30)/g.length,o=d3.select("#commChart").attr("width",k).attr("height",l),p=d3.scale.quantize().domain([0,f.length]).range(i),q=d3.scale.linear().range([0,k-250]).domain([0,d3.max(g)]),r=d3.scale.linear().domain([0,f.length]).range([0,m]),s=d3.svg.axis().orient("left").scale(r).ticks(f.length).tickSize(0).tickFormat(function(a,b){return f[b]});o.append("g").attr("class","x axis").attr("transform","translate(220,"+m+")").call(c().tickSize(2).tickFormat(e)),o.append("g").attr("class","grid").attr("transform","translate(220,"+m+")").style("stroke-dasharray","1, 2").call(c().tickSize(-m,0,0).tickFormat(""));o.append("g").attr("transform","translate(220,0)").attr("id","yaxis").call(s).selectAll("text").attr("y",n/2);o.append("text").attr("class","x-label").attr("text-anchor","end").attr("x",k/2+110).attr("y",l-2).text(d);var u=o.append("g").attr("transform","translate(220, 0)").attr("id","bars").selectAll("rect").data(g).enter();u.append("rect").attr("transform",function(a,b){return"translate(0, "+b*n+")"}).attr("width",0).attr("height",n-2).attr("class","barTip").style("fill",function(a,b){return p(b)}).transition().delay(function(a,b){return 100*b}).duration(400).attr("width",q).attr("val",function(a,b){return a}),$(".barTip").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val");return y="ton"===E?numeral(t(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(t(1e-6*a,2)).format("0,0.0")+" M"}})}function n(a,b){return a-b}function o(a){a=a.sort(n);var b,c=[];for(b=0;b<a.length;b++)a[b]!==a[b-1]&&c.push(a[b]);return c}function p(a){var b,c=null;for(b=0;b<P.length;b++){var d=P[b];parseInt(d.id)===parseInt(a)&&(c=d)}return c}function q(a,b){var c;d3.geo.albersUsa();for(c=0;c<a.length;c++){var d=p(a[c]);if(d){var e=K([d.lon,d.lat]),f=d3.select("#metros").append("g").attr("transform","translate("+Math.round(e[0])+","+Math.round(e[1])+")").attr("r",b).attr("id","metro_"+d.id).attr("class","metro related");f.append("circle").attr("r",b);d.id}}}function r(){$(".flowBtn").attr("disabled",!1),"bucks"===H?$("#dt-county-prev").prop("disabled",!0):"philadelphia"===H?$("#dt-county-next").prop("disabled",!0):($("#dt-county-next").prop("disabled",!1),$("#dt-county-prev").prop("disabled",!1))}function s(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.val-a.val}),a}function t(a,b){return Number(Math.round(a+"e"+b)+"e-"+b)}function u(a,b,c){$(".flowBtn").attr("disabled",!0),$("#tradeList").html(""),setTimeout(r,520);var d,e=s(Q,E),f=[],g=[],h=[],j=[],l=0;for(d=0;d<e.length;d++){var m=e[d];parseInt(m.region_id)===a&&m.rel_region_id!=m.region_id&&m.dir===b&&m.mode===F&&("ton"===E?f.push(parseInt(m.ton)):f.push(parseInt(m.val)))}g=d3.min(f),h=d3.max(f);var n=d3.scale.pow().exponent(.6).domain([g,h]).range([2,35*z]);d3.select("#metros .sel_primary").classed("prevSelection",!0),d3.selectAll("#metros .sel_related").classed("prevSelection",!0),d3.selectAll("#metros .metro").classed("sel_primary",!1).classed("sel_related",!1).classed("in",!1).classed("out",!1),$("svg circle").unbind("mouseenter mouseleave"),d3.select("#metro_"+a).attr("r",15).classed("sel_primary",!0).classed("prevSelection",!1).select("circle").attr("r",15);var o;for(o=0;o<e.length;o++){var q,u,w,x,y=e[o];if("ton"===E?(q=n(y.ton),w=y.ton,x=numeral(t(.001*w,2)).format("0,0.0")+" ktons"):(q=n(y.val),w=y.val,x="$ "+numeral(t(1e-6*w,2)).format("0,0.0")+" M"),parseInt(y.region_id)===a&&y.dir===b&&y.rel_region_id!=y.region_id&&y.mode===F){var A=d3.select("#metro_"+y.rel_region_id),B=p(y.rel_region_id),C=B.id,D=B.familiar_name;if(w>0){var I="<li class='list-group-item' data-id='"+C+"'><span class='badge partner-val'>"+x+"</span>"+D+"</li>";j.push(I)}A.classed("prevSelection",!1),A.classed("sel_related",!0).attr("r",q).classed(b,!0).select("circle").transition().duration(500).attr("r",q).attr("i",l).attr("val",w).attr("name",D),l++}}var J;if(j.length>0)for(i=0;i<10;i++)J=j[i],$(J).appendTo("#tradeList");else{var K=H.slice(0,1).toUpperCase()+H.slice(1,H.length);J="<li class='list-group-item'><b>"+K+" County</b> has no domestic trade using <b>"+F+" transportation.</b></li>","air"===F&&42101===a&&(J+="<li class='list-group-item'>Air transportation through Philadelphia International Airport is captured by Delaware County.</li>"),$(J).appendTo("#tradeList")}d3.selectAll("#metros .prevSelection").classed("prevSelection",!1).attr("r",3).select("circle").transition().duration(500).attr("r",3),v(),$("svg .sel_related circle").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val"),b=this.getAttribute("name");t(a,2);return u="ton"===E?numeral(t(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(t(1e-6*a,2)).format("0,0.0")+" M","<b>"+b+"</b><br>"+u}}),d3.selectAll(".metro circle").on("mouseover",null),d3.selectAll(".metro circle").on("mouseout",null),d3.selectAll(".sel_related circle").on("mouseover",function(a){d3.select(this).classed("active",!0)}).on("mouseout",function(a){d3.select(this).classed("active",!1)}),k(G,E,b,F)}function v(){var a=d3.selectAll("#metros .metro")[0];C.elements(a).start()}function w(){0===$("#tradeMap").length&&j(),k(G,E,D,F)}var x,y,z,A,B,C=sm.packer(),D="in",E="ton",F="all",G=42017,H="none",I="network",J=$("#content").width(),K=d3.geo.albersUsa().scale(900).translate([J,215]),L={region:"Overview",network:"Network",freight_centers:"Freight Centers",domestic_trade:"Domestic Trade Patterns"},M={bucks:42017,burlington:34005,camden:34007,gloucester:34015,mercer:34021,chester:42029,delaware:42045,montgomery:42091,philadelphia:42101},N=document.location.toString();if(N.match("#")){var O=N.split("#")[1].split("/");O.length>1?b(O):a()}$('a[href="#"]').click(function(a){a.preventDefault()}),$(window).bind("hashchange",function(){if("region"===getLocationHash()){var a=window.location.hash.substring(1),c=a.split("/");b(c)}}),$(document.body).on("click","#c-steps li a ",function(){I=$(this).attr("data-target").split("-")[1],"none"===H?($("#c-county-prompt").show(),e()):"region"===I?window.location.hash="region":window.location.hash="region/"+H+"/"+I}),$("#c-county-prompt").on("click",function(){$("#c-county-prompt").hide()}),$("#c-steps li a svg").bind("mouseover",function(){f($(this).parent().find("svg.c-ripple"))}),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var P,Q,R,S,T,U,V=!1;$("input[name='dir']").change(function(){D=$(this).val();var a="in"===D?"Inbound":"Outbound";u(G,D),$("#comm-"+D).prop("checked",!0),$("#tradeDirection").html(a+" <span class='caret'></span>")}),$("input[name='measure']").change(function(){E=$(this).val();var a="ton"===E?"Volume":"Value";u(G,D,"measure"),$("#comm-"+E).prop("checked",!0),$("#tradeMeasure").html(a+" <span class='caret'></span>")}),$("input[name='mode']").change(function(){F=$(this).val(),u(G,D,"measure")}),$("input[name='tradeMeasure']").change(function(){E=$(this).val(),$("#radio_"+E).trigger("click")}),$("input[name='tradeDirection']").change(function(){D=$(this).val(),$("#radio_"+D).trigger("click")}),$(".btn").mouseup(function(){$(this).blur()}),$(document.body).on("mouseover","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!0)}),$(document.body).on("mouseout","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!1)}),$(window).bind("resize",function(){w()})});