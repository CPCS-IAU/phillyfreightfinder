$(function(){var a,b,c=sm.packer(),d='<i class="glyphicon glyphicon-circle-arrow-up"></i>',e='<i class="glyphicon glyphicon-circle-arrow-right"></i>',f='<i class="glyphicon glyphicon-circle-arrow-down"></i>',g=2014;d3.csv("data/d3/port_diagram.csv",function(h){d3.csv("data/d3/port_activity.csv",function(i){d3.json("data/d3/river_diagram.json",function(j){function k(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=v([d.lon,d.lat]),f=d3.select("#ports").append("g").attr("transform","translate("+Math.round(e[0])+","+Math.round(e[1])+")").attr("r",b).attr("id","port_"+d.port_link).attr("class",function(){return"b"===d.port_typ?"port mi-bulk-terminal":"port mi-general-terminal"});f.append("circle").attr("r",b),f.append("text").attr("class","mi-port-label").attr("text-anchor",function(){return"l"===d.dir?"end":"start"}).attr("x",function(){return"l"===d.dir?-18:18}).attr("y",0).attr("dy",".35em").text(d.port_name).call(l,100).attr("transform","rotate(65)")}var g=d3.selectAll(".mi-two-line");g.each(function(){var a=d3.select(this.parentNode);a.select("tspan.mi-child").attr("dy","-.25em")})}function l(a,b){a.each(function(){for(var a,c=d3.select(this),d=c.text().split(/\s+/).reverse(),e=[],f=c.attr("x"),g=c.attr("y"),h=.35,i=c.text(null).append("tspan").attr("class","mi-child").attr("x",f).attr("y",g).attr("dy",h+"em");a=d.pop();)e.push(a),i.text(e.join(" ")),i.node().getComputedTextLength()>b&&(e.pop(),i.text(e.join(" ")),e=[a],i=c.append("tspan").classed("mi-child",!1).attr("class","mi-two-line").attr("x",f).attr("y",g).attr("dy",".65em").text(a))})}function m(a){2003===a?($("#mi-vessel-icon").hide(),$("#mi-shipChange-text").hide(),$("#mi-shipChange-nd").show()):($("#mi-shipChange-nd").hide(),$("#mi-vessel-icon").show(),$("#mi-shipChange-text").show());for(var b=[],c=[],g=[],h=0,j=0,k=0;k<i.length;k++){var l=i[k];b.push(parseInt(l.calls))}for(var c=d3.min(b),g=d3.max(b),m=d3.scale.pow().exponent(.8).domain([c,g]).range([5,19]),k=0;k<i.length;k++){var p,l=i[k],q=0;if(p=m(parseInt(l.calls)),parseInt(l.year)===a&&l.calls>0){h=Number(h)+Number(l.calls);var r=d3.select("#port_"+l.link_id);r.attr("r",p).classed({"mi-no-activity":!1}).select("circle").transition().duration(500).attr("r",p).attr("i",q).attr("val",l.calls).attr("name",n(l.link_id)),q++}else if(parseInt(l.year)===a){var r=d3.select("#port_"+l.link_id);r.attr("r",4).classed({"mi-no-activity":!0}).select("circle").transition().duration(500).attr("r",4).attr("val",l.calls).attr("name",n(l.link_id))}parseInt(l.year)===a-1&&(j=Number(j)+Number(l.calls))}for(var k=0;k<i.length;k++){var l=i[k];if(parseInt(l.year)===a-1){var r=d3.select("#port_"+l.link_id);r.select("circle").attr("prev",l.calls)}}$("svg circle").unbind("mouseenter mouseleave"),$("#mi-vessel-count").html(numeral(h).format("0,0"));var s=(h-j)/j*100;$("#mi-vessel-percent").html(s.toFixed(0)+"%"),s>5?$("#mi-vessel-icon").html(d):-5>s?$("#mi-vessel-icon").html(f):$("#mi-vessel-icon").html(e),o(),d3.selectAll(".port circle").on("mouseover",null),d3.selectAll(".port circle").on("mouseout",null),d3.selectAll(".port circle").on("mouseover",function(a){d3.select(this).classed("active",!0);var b=this.getAttribute("val"),c=this.getAttribute("prev"),g=this.getAttribute("name"),h=(b-c)/c*100;isFinite(h)?$("#mi-vessel-percent").html(h.toFixed(0)+"%"):$("#mi-vessel-percent").html("&#8734;"),$("#mi-vessel-count").html(numeral(b).format("0,0")),$("#mi-vessel-title").html(g),h>5?$("#mi-vessel-icon").html(d):-5>h?$("#mi-vessel-icon").html(f):$("#mi-vessel-icon").html(e)}).on("mouseout",function(a){d3.select(this).classed("active",!1),$("#mi-vessel-count").html(numeral(h).format("0,0")),$("#mi-vessel-percent").html(s.toFixed(0)+"%"),$("#mi-vessel-title").html("All DVRPC Terminals"),s>5?$("#mi-vessel-icon").html(d):-5>s?$("#mi-vessel-icon").html(f):$("#mi-vessel-icon").html(e)}),d3.selectAll(".port text").on("mouseover",function(a){var b=$(this).parent().children("circle");b.toggleClass("active");var c=b.attr("val"),g=b.attr("prev"),h=b.attr("name"),i=(c-g)/g*100;isFinite(i)?$("#mi-vessel-percent").html(i.toFixed(0)+"%"):$("#mi-vessel-percent").html("&#8734;"),$("#mi-vessel-count").html(numeral(c).format("0,0")),$("#mi-vessel-title").html(h),i>5?$("#mi-vessel-icon").html(d):-5>i?$("#mi-vessel-icon").html(f):$("#mi-vessel-icon").html(e)}).on("mouseout",function(a){var b=$(this).parent().children("circle");b.toggleClass("active"),$("#mi-vessel-count").html(numeral(h).format("0,0")),$("#mi-vessel-percent").html(s.toFixed(0)+"%"),$("#mi-vessel-title").html("All DVRPC Terminals"),s>5?$("#mi-vessel-icon").html(d):-5>s?$("#mi-vessel-icon").html(f):$("#mi-vessel-icon").html(e)})}function n(a){for(var b=0;b<h.length;b++){var c=h[b];if(c.port_link===a)return c.port_name}}function o(){var a=d3.selectAll("#ports .port")[0];c.elements(a).start()}function p(a){var b=1e-6*a+" M";return b}function q(a){var b=.001*a+" k";return b}var r=$("#mi-port-diagram-wrapper").width()+40,s=$("#mi-port-diagram-wrapper").height()+30,t=d3.select("#mi-port-diagram").append("svg").attr("width",r).attr("height",s).attr("id","port_map"),u=t.append("g").attr("width",r).attr("height",s).attr("id","river");t.append("g").attr("width",r).attr("height",s).attr("id","ports");var v=d3.geo.mercator().scale(1).translate([0,0]).precision(0).rotate([0,-10,0]),w=d3.geo.path().projection(v),x=w.bounds(j),y=1.12/Math.max((x[1][0]-x[0][0])/r,(x[1][1]-x[0][1])/s),z=[(r-200-y*(x[1][0]+x[0][0]))/2,(s-90-y*(x[1][1]+x[0][1]))/2];v.scale(y).translate(z),u.selectAll("path").data(j.features).enter().append("path").attr("d",w);k(h,3);var A={top:20,right:55,bottom:30,left:60},B=$("#maritimeChartWrapper").width(),C=B-A.left-A.right,D=200-A.top-A.bottom,E=d3.time.format("%Y").parse,F=d3.bisector(function(a){return a.year}).right,G=d3.time.scale().range([0,C]),H=d3.scale.linear().rangeRound([D,0]),I=d3.scale.linear().rangeRound([D,0]),J=d3.layout.stack().offset("zero").values(function(a){return a.values}).x(function(a){return G(a.label)}).y(function(a){return a.value}),K=d3.svg.area().interpolate("cardinal").x(function(a){return G(a.label)}).y0(function(a){return H(a.y0)}).y1(function(a){return H(a.y0+a.y)}),L=d3.scale.ordinal().range(["#7ca0d5","#396ab2","#312A6A"]),M=d3.select("#maritimeTradeChart").append("svg").attr("width",C+A.left+A.right).attr("height",D+A.top+A.bottom).append("g").attr("transform","translate("+A.left+","+A.top+")");d3.csv("data/d3/maritimeIndicators.csv",function(c){function h(){var a=G.invert(d3.mouse(this)[0]);if(a.getMonth()>5)var b=a.getFullYear()+1;else var b=a.getFullYear();var d=F(c,b,1),e=c[d-1].year,f=c[d].year,g=b-e>f-b?[f,d-1]:[e,d-2];P.transition().duration(50).attr("transform",function(a){var b,c=o[0].values[g[1]].value,d=o[1].values[g[1]].value,f=o[2].values[g[1]].value;switch(a.name){case"swt_import":b=a.values[g[1]].value+c;break;case"domestic":b=a.values[g[1]].value+d+c;break;default:b=a.values[g[1]].value}return $(".mi-dw-year").html(e),$(".mi-dw-domestic").html((1e-6*f).toFixed(2)),$(".mi-dw-import").html((1e-6*d).toFixed(2)),$(".mi-dw-export").html((1e-6*c).toFixed(2)),"translate("+G(E(g[0]))+","+H(b)+")"}),Q.transition().duration(50).attr("transform",function(a){return $(".mi-dw-containers").html((.001*s[g[1]].value).toFixed(0)),"translate("+G(E(g[0]))+","+I(s[g[1]].value)+")"}),O.transition().duration(50).attr("x1",G(E(g[0]))).attr("x2",G(E(g[0]))),G(E(g[0]))>C/2?R.transition().duration(50).style("left",G(E(g[0]))-115+"px"):R.transition().duration(50).style("left",G(E(g[0]))+95+"px")}function i(a,b){return 0>a&&0>b?a>b?-(b-a):a-b:0>a&&b>0?-(b-a):a>b?a-b:b-a}function j(a){return"change"}var k="year",l=(new Date,2015),n=["swt_export","swt_import","domestic"];L.domain(n);var o=[],r={},s=[];n.forEach(function(a){r[a]={name:a,values:[]},o.push(r[a])});var t=d3.max(c,function(a){return a.year});a=t-1,$("#mi-year-select").html(a+' <span class="caret"></span>');for(var u=2003;t>=u;u++)$("#maritime-year-dropdown").append('<li><input type="radio" id="m'+u+'" class="miYear" name="miYear" value="'+u+'"><label for="m'+u+'">'+u+"</label></li>");$("#m"+(t-1)).prop("checked",!0),c.map(function(a){a.year!=l-1&&a.year>2002&&(n.map(function(b){r[b].values.push({label:E(a[k]),value:+a[b]})}),s.push({year:E(a.year),value:+a.cont_teu}))});var v=d3.min(o,function(a){return d3.min(a.values,function(a){return a.label})}),w=d3.max(o,function(a){return d3.max(a.values,function(a){return a.label})});$("#mi-trade-date-min").html(v.getFullYear()),$("#mi-trade-date-max").html(w.getFullYear()),G.domain([v,w]),J(o),H.domain([0,d3.max(o,function(a){return d3.max(a.values,function(a){return a.y0+a.y})})]),I.domain([0,d3.max(s,function(a){return Math.max(a.value)})]);var x=M.selectAll(".series").data(o).enter().append("g").attr("class","series");x.append("path").attr("class","streamPath").attr("d",function(a){return K(a.values)}).style("fill",function(a){return L(a.name)}).style("stroke","white");var y=d3.svg.line().interpolate("cardinal").x(function(a){return G(a.year)}).y(function(a){return I(a.value)});M.append("path").attr("d",y(s)).attr("stroke","#EAA51B").attr("fill","none").attr("stroke-width",2);var z=d3.svg.axis().scale(G).orient("bottom"),A=d3.svg.axis().scale(H).ticks(5).tickFormat(p).orient("left"),B=d3.svg.axis().scale(I).tickFormat(q).ticks(6).orient("right");M.append("g").attr("class","x axis").attr("transform","translate(0,"+D+")").call(z),M.append("g").attr("class","y axis").call(A).append("text").attr("y",-55).attr("dy",".71em").attr("x",-D/2).attr("transform","rotate(-90)").style("text-anchor","middle").text("tons of trade"),M.append("g").attr("class","y0 axis").attr("transform","translate("+C+",0)").call(B).append("text").attr("y",45).attr("dy",".71em").attr("x",-D/2).attr("transform","rotate(-90)").style("text-anchor","middle").text("TEUs of containerized cargo");var N=M.append("g").attr("class","focus").style("display","none").attr("x1",100).attr("x2",100),O=N.append("line").attr("class","mouseLine").attr("stroke-dasharray","2,2").attr("stroke-linecap","round").style("stroke","#efefef").style("stroke-width","1px").attr("x1",10).attr("x2",10).attr("y1",0).attr("y2",D),P=N.selectAll(".circle").data(o).enter().append("circle").attr("class","circle").attr("r",6).attr("fill",function(a){return L(a.name)}).attr("stroke","#fff").attr("transform",function(a){return"translate(0,"+H(a.values[0].y)+")"}),Q=N.selectAll(".containerCircle").data(s).enter().append("circle").attr("class","containerCircle").attr("r",6).attr("fill","#EAA51B").attr("stroke","#fff"),R=d3.select("#maritimeTradeChart").append("div").attr("class","mi-data-window panel panel-primary");R.append("div").html('<div class="mi-dw-title">Trade for <span class="mi-dw-year">2014</span></div><div class=""><div class="mi-data-swatch dkblue-bg"></div> Domestic: <span class="right_align"><span class="mi-dw-domestic">xxx</span> M tons</span></div><div class=""><div class="mi-data-swatch blue-bg"></div>Imports: <span class="right_align"><span class="mi-dw-import">xxx</span> M tons</span></div><div class=""><div class="mi-data-swatch ltblue-bg"></div>Exports: <span class="right_align"><span class="mi-dw-export">xxx</span> M tons</span></div><div class="mi-data-swatch orange-bg"></div>Containers: <span class="right_align"><span class="mi-dw-containers">xxx</span> k TEUs</span></div>'),M.append("svg:rect").attr("class","overlay").attr("width",C).attr("height",D).on("mouseover",function(){N.style("display",null),R.style("display","block")}).on("mouseout",function(){N.style("display","none"),R.style("display","none")}).on("mousemove",h),b=function(a){a===g?($(".mi-data").hide(),$(".mi-no-data").show()):($(".mi-no-data").hide(),$(".mi-data").show()),$("#mi-export-graph").html(""),$("#mi-container-graph").html(""),$(".mi-activity-year").html(a);var b=a-2002;if(""!==c[b].port_rank)var h=c[b].port_rank,k=c[b-1].port_rank,l=h-k,m=parseInt(c[b].swt_import)+parseInt(c[b].swt_export)+parseInt(c[b].domestic),n=numeral(1e-6*m).format("0,0.0")+" M",o=parseInt(c[b-1].swt_import)+parseInt(c[b-1].swt_export)+parseInt(c[b-1].domestic),p=((m-o)/o*100).toFixed(1),q=((parseInt(c[b].nation_tot)-parseInt(c[b-1].nation_tot))/parseInt(c[b-1].nation_tot)*100).toFixed(1),r=i(p,q),s=c[b].foreign_val,t="$"+numeral(1e-9*s).format("0,0")+" B",u=c[b-1].foreign_val,v=(s-u)/u*100,w=(c[b].us_foreign-c[b-1].us_foreign)/c[b-1].us_foreign*100,x=i(v,w),y=parseInt(c[b].swt_export)/(parseInt(c[b].swt_export)+parseInt(c[b].swt_import))*100,z=[y,100-y],A=(parseInt(c[b-1].swt_export)/(parseInt(c[b-1].swt_export)+parseInt(c[b-1].swt_import))*100,(parseInt(c[b].swt_export)-parseInt(c[b-1].swt_export))/parseInt(c[b-1].swt_export)*100),B=(parseInt(c[b].us_export)-parseInt(c[b-1].us_export))/parseInt(c[b-1].us_export)*100,C=1e-6*parseInt(c[b].swt_export),D=i(A,B),E=parseInt(c[b].swt_cont_tons)/(parseInt(c[b].swt_export)+parseInt(c[b].swt_import))*100,F=[E,100-E],G=parseInt(c[b-1].swt_cont_tons)/(parseInt(c[b-1].swt_export)+parseInt(c[b-1].swt_import))*100,H=(E-G)/G*100;$("#mi-rank-value").html(h),0>l?$("#mi-rank-icon").html(d):l>0?$("#mi-rank-icon").html(f):$("#mi-rank-icon").html(e),$("#mi-regional").html(p+"%"),$("#mi-national").html(q+"%"),$("#mi-total-trade-value").html(n),-5>r?$("#mi-total-icon").html(f):r>5?$("#mi-total-icon").html(d):$("#mi-total-icon").html(e),$("#mi-foreign-value").html(t),$("#mi-foreign-percent").html(v.toFixed(1)+"%"),$("#mi-foreign-national").html(w.toFixed(1)+"%"),x>5?$("#mi-foreign-icon").html(d):-5>x?$("#mi-foreign-icon").html(f):$("#mi-foreign-icon").html(e);var I=67,J=$("#mi-export-graph").width(),K=33.5,L=15,M=(.05*J).toFixed(0);if(J>280){$("#mi-export-percent").css("left",Number(103)+Number(M)+"px"),$("#mi-export-overlay").css("background",'url("images/mi_export_overlay.png") no-repeat;').css("left",Number(15)+Number(M)+"px"),$("#mi-export-info-label").css("left",Number(190)+Number(M)+"px");var N=d3.scale.ordinal().range(["#EAA51B","#fff"]),O=N.domain(z),P=(N.domain(F),d3.select("#mi-export-graph").append("svg").attr("width",J).attr("height",108).append("g").attr("transform","translate("+(Number(46)+Number(M))+",54)")),Q=(d3.select("#mi-container-graph").append("svg").attr("width",J).attr("height",108).append("g").attr("transform","translate("+J/2+",54)"),d3.svg.arc().outerRadius(K).startAngle(function(a){return a.startAngle+Math.PI}).endAngle(function(a){return a.endAngle+Math.PI})),R=(d3.svg.arc().innerRadius(K-L).outerRadius(K).startAngle(function(a){return Math.PI-a.startAngle}).endAngle(function(a){return Math.PI-a.endAngle}),d3.layout.pie().value(function(a,b){return a}).sort(null));P.selectAll("path").data(R(z)).enter().append("path").attr("d",Q).attr("fill",function(a,b){return O(a.value)}),d3.select("#mi-export-graph").append("div").attr("id","mi-export-label").style("top",I/2-12+"px")}else $("#mi-export-percent").css("left",Number(28)+Number(.5*M)+"px"),$("#mi-export-overlay").css("background",'url("lib/images/mi_export_overlay-sm.png") no-repeat').css("left",Number(20)+Number(.5*M)+"px"),$("#mi-export-info-label").css("left",Number(120)+Number(.45*M)+"px");J>280&&300>J&&($("#mi-export-percent").css("left","103px"),$("#mi-export-overlay").css("left","15px"),$("#mi-export-info-label").css("left","180px"),$("#mi-export-graph").css("transform","translate(-15px,0)")),$("#mi-export-percent").css("display","block"),$("#mi-export-overlay").css("display","block"),$("#mi-export-info-label").css("display","block"),$("#mi-export-change").html(A.toFixed(1)+"%"),$("#mi-export-percent").html(y.toFixed(0)+"%"),$("#mi-export-national").html(B.toFixed(1)+"%"),$("#mi-export-value").html(C.toFixed(1)+" M"),$("#mi-export-indicator").html(j(A)),D>5?$("#mi-export-icon").html(d):-5>D?$("#mi-export-icon").html(f):$("#mi-export-icon").html(e),$("#mi-container-percent").html(H.toFixed(0)+"%"),$("#mi-container-indicator").html(j(H)),H>3?$("#mi-container-icon").html(d):-3>H?$("#mi-container-icon").html(f):$("#mi-container-icon").html(e)},b(a),m(a);var S=a;$("#maritime-year-dropdown").on("change","input",function(){S=parseInt($(this).val());var a=document.getElementById("m"+(S-1));b(S),m(S),a?w?($("#mi-year-prev").prop("disabled",!1),$("#mi-year-next").prop("disabled",!1)):$("#mi-year-next").prop("disabled",!0):$("#mi-year-prev").prop("disabled",!0)}),$("#mi-year-prev").on("click",function(){var a=$("#m"+(S-1));a.trigger("click")}),$("#mi-year-next").on("click",function(){var a=$("#m"+(S+1));a.trigger("click")}),$(".btn").mouseup(function(){$(this).blur()})})})})})});