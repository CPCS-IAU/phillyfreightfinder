!function(){"use strict";d3.csv("data/d3/commRegions_v2.csv",function(a){d3.csv("data/d3/totalFlowsBEA.csv",function(b){d3.csv("data/d3/commodities.csv",function(c){d3.csv("data/d3/stcc.csv",function(d){function e(a,b,d,e){var h,i=a,j=b,k=d,l=e,m=[];for(h=0;h<c.length;h++){var n=c[h];n.dir===k&&parseInt(n.region)===i&&n.mode.toLowerCase()===l&&m.push(n)}var o=f(m,j);g(o)}function f(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.value-a.value}),a}function g(a){function b(a){var b=k(a);"ton"===u?h.push(parseInt(a.ton)):h.push(parseInt(a.value)),g.push(b)}function c(){return d3.svg.axis().scale(v).orient("bottom").ticks(5)}function e(){return"ton"===u?"thousand tons of activity":"million dollars of activity"}function f(a){var b;return b="ton"===u?numeral(n(.001*a,2)).format("0,0"):"$ "+numeral(n(1e-6*a,2)).format("0,0")}var g=[],h=[];$("#commChart").empty().html("");var i,j=["#312A6A","#323576","#35478A","#36559A","#2E5EA5","#396ab2","#4276c2","#5584c9","#6992cf","#7ca0d5"],k=function(a){var b,c=null;for(b=0;b<d.length;b++){var e=d[b];parseInt(e.stcc)===parseInt(a.stcc4)&&(c=e.name)}return c};if(a.length<10)for(i=0;i<a.length;i++)q=a[i],b(q);else for(i=0;10>i;i++)q=a[i],b(q);var l=document.getElementById("topCommoditiesChart").offsetWidth,m=305,o=275,p=(m-30)/h.length,s=d3.select("#commChart").attr("width",l).attr("height",m),t=d3.scale.quantize().domain([0,g.length]).range(j),v=d3.scale.linear().range([0,l-250]).domain([0,d3.max(h)]),w=d3.scale.linear().domain([0,g.length]).range([0,o]),x=d3.svg.axis().orient("left").scale(w).ticks(g.length).tickSize(0).tickFormat(function(a,b){return g[b]});s.append("g").attr("class","x axis").attr("transform","translate(220,"+o+")").call(c().tickSize(2).tickFormat(f)),s.append("g").attr("class","grid").attr("transform","translate(220,"+o+")").style("stroke-dasharray","1, 2").call(c().tickSize(-o,0,0).tickFormat(""));s.append("g").attr("transform","translate(220,0)").attr("id","yaxis").call(x).selectAll("text").attr("y",p/2);s.append("text").attr("class","x-label").attr("text-anchor","end").attr("x",l/2+110).attr("y",m-2).text(e);var y=s.append("g").attr("transform","translate(220, 0)").attr("id","bars").selectAll("rect").data(h).enter();y.append("rect").attr("transform",function(a,b){return"translate(0, "+b*p+")"}).attr("width",0).attr("height",p-2).attr("class","barTip").style("fill",function(a,b){return t(b)}).transition().delay(function(a,b){return 100*b}).duration(400).attr("width",v).attr("val",function(a,b){return a}),$(".barTip").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val");return r="ton"===u?numeral(n(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(n(1e-6*a,2)).format("0,0.0")+" M"}})}function h(a,b){return a-b}function i(a){a=a.sort(h);var b,c=[];for(b=0;b<a.length;b++)a[b]!==a[b-1]&&c.push(a[b]);return c}function j(b){var c,d=null;for(c=0;c<a.length;c++){var e=a[c];parseInt(e.id)===parseInt(b)&&(d=e)}return d}function k(a,b){var c;d3.geo.albersUsa();for(c=0;c<a.length;c++){var d=j(a[c]);if(d){var e=A([d.lon,d.lat]),f=d3.select("#metros").append("g").attr("transform","translate("+Math.round(e[0])+","+Math.round(e[1])+")").attr("r",b).attr("id","metro_"+d.id).attr("class","metro related");f.append("circle").attr("r",b);d.id}}}function l(){$(".flowBtn").attr("disabled",!1),"bucks"===x?$("#dt-county-prev").prop("disabled",!0):"philadelphia"===x?$("#dt-county-next").prop("disabled",!0):($("#dt-county-next").prop("disabled",!1),$("#dt-county-prev").prop("disabled",!1))}function m(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.val-a.val}),a}function n(a,b){return Number(Math.round(a+"e"+b)+"e-"+b)}function o(a,c,d){$(".flowBtn").attr("disabled",!0),$("#tradeList").html(""),setTimeout(l,520);var f,g=m(b,u),h=[],i=[],k=[],o=[],q=0;for(f=0;f<g.length;f++){var r=g[f];parseInt(r.region_id)===a&&r.rel_region_id!=r.region_id&&r.dir===c&&r.mode===v&&("ton"===u?h.push(parseInt(r.ton)):h.push(parseInt(r.val)))}i=d3.min(h),k=d3.max(h);var s=d3.scale.pow().exponent(.6).domain([i,k]).range([2,35]);d3.select("#metros .sel_primary").classed("prevSelection",!0),d3.selectAll("#metros .sel_related").classed("prevSelection",!0),d3.selectAll("#metros .metro").classed("sel_primary",!1).classed("sel_related",!1).classed("in",!1).classed("out",!1),$("svg circle").unbind("mouseenter mouseleave"),d3.select("#metro_"+a).attr("r",15).classed("sel_primary",!0).classed("prevSelection",!1).select("circle").attr("r",15);var t;for(t=0;t<g.length;t++){var y,z,A,B,C=g[t];if("ton"===u?(y=s(C.ton),A=C.ton,B=numeral(n(.001*A,2)).format("0,0.0")+" ktons"):(y=s(C.val),A=C.val,B="$ "+numeral(n(1e-6*A,2)).format("0,0.0")+" M"),parseInt(C.region_id)===a&&C.dir===c&&C.rel_region_id!=C.region_id&&C.mode===v){var D=d3.select("#metro_"+C.rel_region_id),F=j(C.rel_region_id),G=F.familiar_name;if(A>0){var H="<li class='list-group-item'><span class='badge partner-val'>"+B+"</span>"+G+"</li>";o.push(H)}D.classed("prevSelection",!1),D.classed("sel_related",!0).attr("r",y).classed(c,!0).select("circle").transition().duration(500).attr("r",y).attr("i",q).attr("val",A).attr("name",G),q++}}var I;if(o.length>0)for(E=0;10>E;E++)I=o[E],$(I).appendTo("#tradeList");else{var J=x.slice(0,1).toUpperCase()+x.slice(1,x.length);I="<li class='list-group-item'><b>"+J+" County</b> has no domestic trade using <b>"+v+" transportation.</b></li>","air"===v&&42101===a&&(I+="<li class='list-group-item'>Air transportation through Philadelphia International Airport is captured by Delaware County.</li>"),$(I).appendTo("#tradeList")}d3.selectAll("#metros .prevSelection").classed("prevSelection",!1).attr("r",3).select("circle").transition().duration(500).attr("r",3),p(),$("svg .sel_related circle").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val"),b=this.getAttribute("name");n(a,2);return z="ton"===u?numeral(n(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(n(1e-6*a,2)).format("0,0.0")+" M","<b>"+b+"</b><br>"+z}}),d3.selectAll(".metro circle").on("mouseover",null),d3.selectAll(".metro circle").on("mouseout",null),d3.selectAll(".sel_related circle").on("mouseover",function(a){d3.select(this).classed("active",!0)}).on("mouseout",function(a){d3.select(this).classed("active",!1)}),e(w,u,c,v)}function p(){var a=d3.selectAll("#metros .metro")[0];s.elements(a).start()}var q,r,s=sm.packer(),t="in",u="ton",v="all",w=42017,x="bucks",y=d3.select("#content").append("svg").attr("width",960).attr("height",500).attr("id","tradeMap"),z=y.append("g").attr("width",960).attr("height",500).attr("id","states");y.append("g").attr("width",960).attr("height",500).attr("id","metros"),y.append("g").attr("width",960).attr("height",500).attr("id","temp");var A=d3.geo.albersUsa().scale(900).translate([480,250]),B=d3.geo.path().projection(A);d3.json("data/d3/us_states_shapes.json",function(a){z.selectAll("path").data(a.features).enter().append("path").attr("d",B).attr("class","states_outline")});for(var C=[],D=[],E=0;E<b.length;E++)C.push(parseInt(b[E].region_id)),D.push(parseInt(b[E].rel_region_id));C=i(C),D=i(D);var F=i(C.concat(D));k(F,3),o(w,t),$("input[name='dir']").change(function(){t=$(this).val();var a="in"===t?"Inbound":"Outbound";o(w,t),$("#comm-"+t).prop("checked",!0),$("#tradeDirection").html(a+" <span class='caret'></span>")}),$("input[name='county']").change(function(){d3.selectAll("#temp text").remove(),x=this.id,w=parseInt($(this).val()),o(w,t)}),$("input[name='measure']").change(function(){u=$(this).val();var a="ton"===u?"Volume":"Value";o(w,t,"measure"),$("#comm-"+u).prop("checked",!0),$("#tradeMeasure").html(a+" <span class='caret'></span>")}),$("input[name='mode']").change(function(){v=$(this).val(),o(w,t,"mode")}),$("input[name='tradeMeasure']").change(function(){u=$(this).val(),$("#radio_"+u).trigger("click")}),$("input[name='tradeDirection']").change(function(){t=$(this).val(),$("#radio_"+t).trigger("click")}),$("#dt-county-prev").on("click",function(){var a=$("#"+x).parent().prev().children();a.trigger("click")}),$("#dt-county-next").on("click",function(){var a=$("#"+x).parent().next().children();a.trigger("click")}),$(".btn").mouseup(function(){$(this).blur()})})})})})}();