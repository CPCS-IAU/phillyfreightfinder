$(function(){function a(){function a(){var a=$("#c-map-wrapper").width(),b=420;0===$("#c-region-map").length&&d3.json("data/county_10k.js",function(c){var d=d3.select("#c-county-map").append("svg").attr("width",a).attr("height",b).attr("id","c-region-map"),e=d.append("g").attr("width",a).attr("height",b).attr("id","counties"),f=d.append("g").attr("width",a).attr("height",b).attr("id","cty_labels_outlines"),g=d.append("g").attr("width",a).attr("height",b).attr("id","cty_labels"),h=d3.geo.mercator().scale(1).translate([0,0]).precision(0),i=d3.geo.path().projection(h),j=i.bounds(c),k=1/Math.max((j[1][0]-j[0][0])/a,(j[1][1]-j[0][1])/b),l=[(a-k*(j[1][0]+j[0][0]))/2,(b-k*(j[1][1]+j[0][1]))/2];h.scale(k).translate(l),e.selectAll("path").data(c.features).enter().append("path").attr("d",i).attr("id",function(a){return"c-"+a.properties.NAME.toLowerCase()}).attr("class","county_outlines").on("mouseover",function(){var a=d3.select(this);a.transition().duration(250).style("fill-opacity","0.8"),a.style("stroke-width","5px")}).on("mouseout",function(){var a=d3.select(this);a.transition().delay(5).style("stroke-width","2px").style("fill-opacity","1")}).on("click",function(){$("#c-county-prompt").hide();var a=d3.select(this).attr("id").split("-");K=a[1],J=R[K],window.location.hash="region/"+K+"/"+L});f.selectAll("text").data(c.features).enter().append("text").attr("class","c-county-label-outline").attr("transform",function(a){return"translate("+i.centroid(a)+")"}).text(function(a){return a.properties.NAME}),g.selectAll("text").data(c.features).enter().append("text").attr("class","c-county-label").attr("transform",function(a){return"translate("+i.centroid(a)+")"}).text(function(a){return a.properties.NAME})})}function b(a){switch(a){case"region":$(".c-nav").hide();break;case"network":$(".c-nav-left").hide(),$(".c-nav-right").show(),$("#c-nav-right-label").html("Freight Centers");break;case"freight_centers":$(".c-nav-left").show(),$(".c-nav-right").show(),$("#c-nav-left-label").html("Network"),$("#c-nav-right-label").html("Domestic Trade");break;case"domestic_trade":$(".c-nav-left").show(),$(".c-nav-right").hide(),$("#c-nav-left-label").html("Freight Centers")}}function c(){var a=$("#cty-pic-slider").width()/1.38-59;$(window).width()>=992&&$("#c-county-desc").animate({"min-height":a},500),$("#c-county-desc").html(T[K]),$("#c-map-legend").hasClass("open")&&$("#c-map-legend").trigger("click"),$("#c-region-network-map").attr("src","lib/images/county/"+K+"_map.png").attr("alt",k(K)+" County Map"),"undefined"==typeof D?d3.csv("data/county_network.csv",function(a){D=a,d()}):d()}function d(){for(var a=0;a<D.length;a++)if(D[a].NAME===k(K)){var b=D[a],c=a;0===parseInt(b.portTermin)?$("#c-stat-maritime").hide():$("#c-stat-maritime").show();for(var d=0;d<S.length;d++)$(".c-data-"+S[d]).html(b[S[d]]);$(".c-image-caption").html(b.zero),$("#cty-pic-slider").removeData("flexslider"),$("#cty-pic-carousel").removeData("flexslider"),$(".c-slides").html("");for(var e=1;8>e;e++)$(".c-slides").append('<li><img src="lib/images/county/small/'+b.NAME+"/"+e+'.jpg" /></li>')}$(".loading_panel").delay(500).fadeOut("slow"),$("#c-map-legend").delay(500).fadeIn("slow"),$("#cty-pic-slider").flexslider({animation:"fade",controlNav:!1,animationLoop:!1,slideshow:!1,sync:"#cty-pic-carousel",after:function(){var a=N[$("#cty-pic-slider").data("flexslider").currentSlide];$(".c-image-caption").html(D[c][a])}}),$("#cty-pic-carousel").flexslider({animation:"slide",controlNav:!1,animationLoop:!1,slideshow:!1,itemWidth:100,itemMargin:5,asNavFor:"#cty-pic-slider"})}function e(d){K=d.length>1?d[1]:"none",L=d.length>1?d[2]:"region",J=R[K];var e=$('#c-steps li a[data-target="c-'+L+'"] ');$(".c-step-current").find("svg.c-step-nav circle:first").attr("r",5),$(".c-step-current").find("svg.c-step-nav circle:nth-child(2)").attr("r",6),$(".c-step-current").toggleClass("c-step-current"),e.closest("li").toggleClass("c-step-current"),e.find("svg.c-step-nav circle:first").attr("r",8),e.find("svg.c-step-nav circle:nth-child(2)").attr("r",3),$(".c-region-tab").hide(),$("#c-"+L).show(),$("#c-name").html(k(K)+" County"),$("#c-tab").html(P[L]),b(L),"region"===L?(E=$("#c-explore-emphasis").width(),$("#c-explore-emphasis").css("width",E+"px"),M=$("#content").width(),a(),L="network",K="none",$("#c-name").html("DVRPC Region"),$("#c-explorer-block").fadeOut("slow")):"domestic_trade"===L?($(".loading_panel").show(),l()):"network"===L&&($(".loading_panel").show(),c())}function f(a,b,c){var d=0,e=window.setInterval(function(){a(),++d===c&&window.clearInterval(e)},b)}function g(){$("#c-county-prompt").hasClass("c-light")?$("#c-county-prompt").css("background-color","#312867").toggleClass("c-light"):$("#c-county-prompt").css("background-color","#7a6aa2").toggleClass("c-light")}function h(){f(g,250,10)}function j(a){function b(){c.style("stroke-width","0px"),c.transition().duration(1).attr("r",8),c.style("stroke-opacity",1)}var c=d3.select("#"+a).select("circle");setTimeout(b,351),c.style("stroke-width","1px"),c.transition().duration(348).attr("r",20),c.style("stroke-opacity",0)}function k(a){return a.charAt(0).toUpperCase()+a.slice(1)}function l(){d3.csv("data/d3/commRegions_v2.csv",function(a){d3.csv("data/d3/totalFlowsBEA.csv",function(b){d3.csv("data/d3/commodities.csv",function(c){d3.csv("data/d3/stcc.csv",function(d){d3.json("data/d3/us_states_shapes.json",function(e){X=a,Y=b,Z=c,_=d,aa=e,"domestic_trade"===L&&m()})})})})})}function m(){if(M=$("#content").width(),0===$("#tradeMap").length){G="in",H="ton",I="all";var a=d3.select("#content").append("svg").attr("width",M).attr("height",430).attr("id","tradeMap"),b=a.append("g").attr("width",M).attr("height",430).attr("id","states");a.append("g").attr("width",M).attr("height",430).attr("id","metros"),a.append("g").attr("width",M).attr("height",430).attr("id","temp");var c=d3.geo.path().projection(O),d=c.bounds(aa),e=(d[1][0]-d[0][0]-15)/(M-50),f=(d[1][1]-d[0][1])/430,g=e>f?900/e:900,h=e>f?e:1;B=h>1?1/h:1,C=1/h*(d[1][0]-d[0][0])/2;var i=[C,215];O.scale(g).translate(i),b.selectAll("path").data(aa.features).enter().append("path").attr("d",c).attr("class","states_outline");for(var j=[],k=[],l=0;l<Y.length;l++)j.push(parseInt(Y[l].region_id)),k.push(parseInt(Y[l].rel_region_id));j=r(j),k=r(k),ba=r(j.concat(k)),t(ba,3),x(J,G),$(".loading_panel").fadeOut("slow"),ca=!1}else $("#metros").empty(),G="in",H="ton",I="all",t(ba,3),x(J,G),$("#radio_"+H).trigger("click"),$("#radio_"+G).trigger("click"),$("#"+I).trigger("click"),$("#comm-in").prop("checked",!0),$("#tradeDirection").html("Inbound <span class='caret'></span>"),$("#comm-ton").prop("checked",!0),$("#tradeMeasure").html("Volume <span class='caret'></span>"),$("#comm-"+H).prop("checked",!0),$(".loading_panel").fadeOut("slow")}function n(a,b,c,d){var e,f=a,g=b,h=c,i=d,j=[];for(e=0;e<Z.length;e++){var k=Z[e];k.dir===h&&parseInt(k.region)===f&&k.mode.toLowerCase()===i&&j.push(k)}var l=o(j,g);p(l)}function o(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.value-a.value}),a}function p(a){function b(a){var b=j(a);"ton"===H?g.push(parseInt(a.ton)):g.push(parseInt(a.value)),f.push(b)}function c(){return d3.svg.axis().scale(q).orient("bottom").ticks(5)}function d(){return"ton"===H?"thousand tons of activity":"million dollars of activity"}function e(a){var b;return b="ton"===H?numeral(w(.001*a,2)).format("0,0"):"$ "+numeral(w(1e-6*a,2)).format("0,0")}var f=[],g=[];$("#commChart").empty().html("");var h,i=["#312A6A","#323576","#35478A","#36559A","#2E5EA5","#396ab2","#4276c2","#5584c9","#6992cf","#7ca0d5"],j=function(a){var b,c=null;for(b=0;b<_.length;b++){var d=_[b];parseInt(d.stcc)===parseInt(a.stcc4)&&(c=d.name)}return c};if(a.length<10)for(h=0;h<a.length;h++)z=a[h],b(z);else for(h=0;10>h;h++)z=a[h],b(z);var k=$("#topCommoditiesChart").width(),l=305,m=275,n=(l-30)/g.length,o=d3.select("#commChart").attr("width",k).attr("height",l),p=d3.scale.quantize().domain([0,f.length]).range(i),q=d3.scale.linear().range([0,k-250]).domain([0,d3.max(g)]),r=d3.scale.linear().domain([0,f.length]).range([0,m]),s=d3.svg.axis().orient("left").scale(r).ticks(f.length).tickSize(0).tickFormat(function(a,b){return f[b]});o.append("g").attr("class","x axis").attr("transform","translate(220,"+m+")").call(c().tickSize(2).tickFormat(e)),o.append("g").attr("class","grid").attr("transform","translate(220,"+m+")").style("stroke-dasharray","1, 2").call(c().tickSize(-m,0,0).tickFormat(""));o.append("g").attr("transform","translate(220,0)").attr("id","yaxis").call(s).selectAll("text").attr("y",n/2);o.append("text").attr("class","x-label").attr("text-anchor","end").attr("x",k/2+110).attr("y",l-2).text(d);var t=o.append("g").attr("transform","translate(220, 0)").attr("id","bars").selectAll("rect").data(g).enter();t.append("rect").attr("transform",function(a,b){return"translate(0, "+b*n+")"}).attr("width",0).attr("height",n-2).attr("class","barTip").style("fill",function(a,b){return p(b)}).transition().delay(function(a,b){return 100*b}).duration(400).attr("width",q).attr("val",function(a,b){return a}),$(".barTip").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val");return A="ton"===H?numeral(w(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(w(1e-6*a,2)).format("0,0.0")+" M"}})}function q(a,b){return a-b}function r(a){a=a.sort(q);var b,c=[];for(b=0;b<a.length;b++)a[b]!==a[b-1]&&c.push(a[b]);return c}function s(a){var b,c=null;for(b=0;b<X.length;b++){var d=X[b];parseInt(d.id)===parseInt(a)&&(c=d)}return c}function t(a,b){var c;d3.geo.albersUsa();for(c=0;c<a.length;c++){var d=s(a[c]);if(d){var e=O([d.lon,d.lat]),f=d3.select("#metros").append("g").attr("transform","translate("+Math.round(e[0])+","+Math.round(e[1])+")").attr("r",b).attr("id","metro_"+d.id).attr("class","metro related");f.append("circle").attr("r",b);d.id}}}function u(){$(".flowBtn").attr("disabled",!1),"bucks"===K?$("#dt-county-prev").prop("disabled",!0):"philadelphia"===K?$("#dt-county-next").prop("disabled",!0):($("#dt-county-next").prop("disabled",!1),$("#dt-county-prev").prop("disabled",!1))}function v(a,b){return"ton"===b?a.sort(function(a,b){return b.ton-a.ton}):a.sort(function(a,b){return b.val-a.val}),a}function w(a,b){return Number(Math.round(a+"e"+b)+"e-"+b)}function x(a,b,c){$(".flowBtn").attr("disabled",!0),$("#tradeList").html(""),setTimeout(u,520);var d,e=v(Y,H),f=[],g=[],h=[],j=[],k=0;for(d=0;d<e.length;d++){var l=e[d];parseInt(l.region_id)===a&&l.rel_region_id!=l.region_id&&l.dir===b&&l.mode===I&&("ton"===H?f.push(parseInt(l.ton)):f.push(parseInt(l.val)))}g=d3.min(f),h=d3.max(f);var m=d3.scale.pow().exponent(.6).domain([g,h]).range([2,35*B]);d3.select("#metros .sel_primary").classed("prevSelection",!0),d3.selectAll("#metros .sel_related").classed("prevSelection",!0),d3.selectAll("#metros .metro").classed("sel_primary",!1).classed("sel_related",!1).classed("in",!1).classed("out",!1),$("svg circle").unbind("mouseenter mouseleave"),d3.select("#metro_"+a).attr("r",15).classed("sel_primary",!0).classed("prevSelection",!1).select("circle").attr("r",15);var o;for(o=0;o<e.length;o++){var p,q,r,t,x=e[o];if("ton"===H?(p=m(x.ton),r=x.ton,t=numeral(w(.001*r,2)).format("0,0.0")+" ktons"):(p=m(x.val),r=x.val,t="$ "+numeral(w(1e-6*r,2)).format("0,0.0")+" M"),parseInt(x.region_id)===a&&x.dir===b&&x.rel_region_id!=x.region_id&&x.mode===I){var z=d3.select("#metro_"+x.rel_region_id),A=s(x.rel_region_id),C=A.id,D=A.familiar_name;if(r>0){var E="<li class='list-group-item' data-id='"+C+"'><span class='badge partner-val'>"+t+"</span>"+D+"</li>";j.push(E)}z.classed("prevSelection",!1),z.classed("sel_related",!0).attr("r",p).classed(b,!0).select("circle").transition().duration(500).attr("r",p).attr("i",k).attr("val",r).attr("name",D),k++}}var F;if(j.length>0)for(i=0;i<10;i++)F=j[i],$(F).appendTo("#tradeList");else{var G=K.slice(0,1).toUpperCase()+K.slice(1,K.length);F="<li class='list-group-item'><b>"+G+" County</b> has no domestic trade using <b>"+I+" transportation.</b></li>","air"===I&&42101===a&&(F+="<li class='list-group-item'>Air transportation through Philadelphia International Airport is captured by Delaware County.</li>"),$(F).appendTo("#tradeList")}d3.selectAll("#metros .prevSelection").classed("prevSelection",!1).attr("r",3).select("circle").transition().duration(500).attr("r",3),y(),$("svg .sel_related circle").tipsy({gravity:"n",html:!0,title:function(){var a=this.getAttribute("val"),b=this.getAttribute("name");w(a,2);return q="ton"===H?numeral(w(.001*a,2)).format("0,0.0")+" ktons":"$ "+numeral(w(1e-6*a,2)).format("0,0.0")+" M","<b>"+b+"</b><br>"+q}}),d3.selectAll(".metro circle").on("mouseover",null),d3.selectAll(".metro circle").on("mouseout",null),d3.selectAll(".sel_related circle").on("mouseover",function(a){d3.select(this).classed("active",!0)}).on("mouseout",function(a){d3.select(this).classed("active",!1)}),n(J,H,b,I)}function y(){var a=d3.selectAll("#metros .metro")[0];F.elements(a).start()}var z,A,B,C,D,E,F=sm.packer(),G="in",H="ton",I="all",J=42017,K="none",L="network",M=$("#content").width(),N={0:"zero",1:"one",2:"two",3:"three",4:"four",5:"five",6:"six",7:"seven"},O=d3.geo.albersUsa().scale(900).translate([M,215]),P={region:"Overview",network:"Network",freight_centers:"Freight Centers",domestic_trade:"Domestic Trade Patterns"},Q={Network:"network","Freight Centers":"freight_centers","Domestic Trade":"domestic_trade"},R={bucks:42017,burlington:34005,camden:34007,gloucester:34015,mercer:34021,chester:42029,delaware:42045,montgomery:42091,philadelphia:42101},S=["IntRouteMi","NatHwyMile","NHS","interch","freightRai","yards","portTermin","ShipCalls","centers","centerEmp","truckStop"],T={bucks:"Widely known for its idyllic open spaces, pristine streams and rivers, and attractive communities, Bucks County, Pennsylvania also boasts one of the Philadelphia region’s most comprehensive and sophisticated ranges of freight facilities and services. This collective freight network forms a true asset that produces well-paying jobs for county residents, critical tax ratables for boroughs and townships, and an immutable anchor for current and future land development.",burlington:"Burlington County, New Jersey, is a powerhouse of freight activity with large doses of personal touches. The County is strategically located within the Northeastern United States megalopolis and that makes it an ideal logistics platform for Trenton, Philadelphia, North Jersey, and even New York City. At the same time, the County retains an unmistakable familial quality that springs from the steadfast commitment of key individuals and successive generations to promoting economic development and prosperity.",camden:"Bountiful in freight facilities and services, Camden County, New Jersey offers a wealth of supply chain solutions. Using strategic public-private partnerships and investments, the County has successfully re-loaded its arsenal of multi-modal freight capabilities. An earnest desire to speak the language of the customer and a watchful eye on major trade developments such as the Panama Canal expansion further accentuate the County’s global outlook and integrative spirit.",chester:"In Chester County, Pennsylvania, freight delivers, freight flourishes, and freight votes. Illustrations and paintings by the Wyeth family and Horace Pippin have popularized naturalistic, halcyon images of the County. Yet, there also exists a crystal clear reality to an alternative perspective and depiction of the County: one where products of substance and fortitude originate, freight facilities and services thrive, and economic development and sustainable transportation planning principles are shrewdly combined through the County’s award winning <i>Landscapes2</i> initiative.",delaware:"In unrelenting fashion, freight activity in Delaware County, Pennsylvania pulses with vigor and precision. Air, highway, marine, and rail freight facilities operate in a state of perpetual motion throughout the County.  Buoyed by a fully integrated transportation network, the harmonious co-mingling of freight and passenger traffic of all kinds is a daily spectacle.",gloucester:"Agile and formidable—these are the hallmarks of freight activity and freight facilities in Gloucester County, New Jersey.  While worldwide distribution patterns are unpredictable and subject to rapid change, Gloucester County businesses, logistics practices, and transportation facilities exhibit a remarkable ability to evolve and flourish.  With companies like Sony, Home Depot, and Mullica Hill Cold Storage calling Gloucester County home, the County has moved well beyond its agricultural underpinnings and developed an elaborate industrial core and multi-modal freight network.",mercer:"At the center of it all, Mercer County, New Jersey is a pivotal, forceful springboard for freight shipments. Its logistical prowess is forever memorialized by the marque <i>TRENTON MAKES THE WORLD TAKES</i> bridge minutes from the New Jersey State House. Today, Mercer County’s freight activity resonates in new and varied forms that capitalize on distinct locational advantages and direct access to some of the world’s most modern transportation facilities and networks.",montgomery:"An economic juggernaut, Montgomery County, Pennsylvania’s prosperity and prestige are enabled by a masterful freight network. Fabled logistics successes fueled a young nation’s army at Valley Forge, a massive steel mill in Conshohocken, and, more recently, a glamorous mega-mall at King of Prussia. Now punctuated by some of the nation’s most affluent communities and most recognized businesses, Montgomery County provides a textbook example of the inexorable link between readily available freight transportation facilities and services and economic vibrancy.",philadelphia:"Like powerful Internet networking tools, Philadelphia, Pennsylvania’s freight system affords rapid, productive, and global connections. Once known as the <i>Workshop of the World</i>, Philadelphia now serves as the calling card of the Delaware Valley region’s impressive freight assets. For even the casual observer, the City’s prominence in international commerce is abundantly evident: mammoth container cranes, multi-cultural company logos, and non-stop daily pick-up and delivery patterns dot the landscape."};$(".loading_panel").html("").html('<div class="spin-item"><div class="item-inner"><div class="item-loader-container"><div class="la-ball-spin-clockwise la-2x"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div></div>');var U=($("#c-region-title").width()-450)/5;line_width=U/2*3+18,$(".c-step-item").css("width",U+"px"),$(".c-step-line").css("width",2*U+"px").css("transform","translate("+line_width+"px, 0)");var V=document.location.toString();if(V.match("#")){var W=V.split("#")[1].split("/");W.length>1?e(W):($("#c-region").fadeIn(),$("#c-name").html("DVRPC Region"),$("#c-tab").html("Overview"),E=$("#c-explore-emphasis").width(),$("#c-explore-emphasis").css("width",E+"px"),a(),$("#c-explorer-block").fadeOut("slow"))}$('a[href="#"]').click(function(a){a.preventDefault()}),$(window).bind("hashchange",function(){if("region"===getLocationHash()){var a=window.location.hash.substring(1),b=a.split("/");e(b)}}),$(document.body).on("click","#c-steps li a ",function(){L=$(this).attr("data-target").split("-")[1],"none"===K?($("#c-county-prompt").show(),h()):"region"===L?window.location.hash="region":window.location.hash="region/"+K+"/"+L}),$(document.body).on("click",".c-nav",function(){var a=$(this).find("span").text();L=Q[a],window.location.hash="region/"+K+"/"+L}),$(document.body).on("click","#c-map-legend",function(){var a=$(this).attr("class");"closed"===a?($(this).css("width","240px").css("height","145px").css("border-radius","4px 20px 4px 4px").toggleClass("closed open"),$("#c-legend-icon i").toggleClass("dynico dynico-layers glyphicon glyphicon-minus"),$(".c-legend-list").show()):($(this).css("width","40px").css("height","40px").css("border-radius","20px").toggleClass("open closed"),$("#c-legend-icon i").toggleClass("glyphicon glyphicon-minus dynico dynico-layers"),$(".c-legend-list").hide())}),$(document.body).on("mouseover","#c-explore-emphasis",function(){$("#c-explore-emphasis").css("width",E+100+"px")}),$(document.body).on("mouseout","#c-explore-emphasis",function(){$("#c-explore-emphasis").css("width",E+"px")}),$("#c-county-prompt").on("click",function(){$("#c-county-prompt").hide()}),$("#c-steps li a svg").bind("mouseenter",function(){j($(this).parent().find("svg.c-ripple").attr("id"))}),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};var X,Y,Z,_,aa,ba,ca=!1;$("input[name='dir']").change(function(){G=$(this).val();var a="in"===G?"Inbound":"Outbound";x(J,G),$("#comm-"+G).prop("checked",!0),$("#tradeDirection").html(a+" <span class='caret'></span>")}),$("input[name='measure']").change(function(){H=$(this).val();var a="ton"===H?"Volume":"Value";x(J,G,"measure"),$("#comm-"+H).prop("checked",!0),$("#tradeMeasure").html(a+" <span class='caret'></span>")}),$("input[name='mode']").change(function(){I=$(this).val(),x(J,G,"measure")}),$("input[name='tradeMeasure']").change(function(){H=$(this).val(),$("#radio_"+H).trigger("click")}),$("input[name='tradeDirection']").change(function(){G=$(this).val(),$("#radio_"+G).trigger("click")}),$(".btn").mouseup(function(){$(this).blur()}),$(document.body).on("mouseover","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!0)}),$(document.body).on("mouseout","#tradeList .list-group-item",function(){var a=$(this).attr("data-id");d3.select("#metros #metro_"+a).select("circle").classed("list_circle",!1)})}executeOnLoad("c-region-nav",a)});